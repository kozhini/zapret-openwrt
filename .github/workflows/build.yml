name: Manual build Zapret2

on:
  workflow_dispatch:
    inputs:
      test_build:
        description: 'Test build'
        required: false
        default: 'false'
        type: choice
        options:
          - true
          - false
      fake_build:
        description: 'Fake build'
        required: false
        default: 'false'
        type: choice
        options:
          - true
          - false
      max_speed:
        description: 'Build with max speed'
        required: false
        default: 'true'
        type: choice
        options:
          - true
          - false
  push:
    tags:
      - 'v[0-9]*'

env:
  REPO_LNK: bol-van/zapret2
  TARGET_ARCH: aarch64_cortex-a53
  TARGET_BRANCH: openwrt-24.10

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.gh.outputs.tag }}
      build_date: ${{ steps.gh.outputs.build_date }}
      zapret_commit: ${{ steps.upstream.outputs.commit }}
      zapret_commit_short: ${{ steps.upstream.outputs.commit_short }}
      is_active: ${{ steps.activity.outputs.is_active }}
      test_build: ${{ github.event.inputs.test_build || 'false' }}
      fake_build: ${{ github.event.inputs.fake_build || 'false' }}
      max_speed: ${{ github.event.inputs.max_speed || 'true' }}
      target_arch: ${{ env.TARGET_ARCH }}
      target_branch: ${{ env.TARGET_BRANCH }}
    steps:
      - name: Get repo data via GH API
        id: gh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH=$(gh api repos/$REPO_LNK --jq '.default_branch')
          REPO_DATE=$(gh api repos/$REPO_LNK/commits/$BRANCH --jq '.commit.committer.date')
          BUILD_DATE=$(date --utc +'%Y%m%d')
          echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "REPO_DATE=$REPO_DATE" >> $GITHUB_ENV

      - name: Get upstream zapret2 latest commit
        id: upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ZAPRET_COMMIT=$(gh api repos/bol-van/zapret2/commits/master --jq '.sha')
          echo "commit=$ZAPRET_COMMIT" >> $GITHUB_OUTPUT
          echo "commit_short=$(echo $ZAPRET_COMMIT | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Check for repo activity
        id: activity
        run: |
          echo "is_active=true" >> $GITHUB_OUTPUT

  build:
    needs: check
    if: needs.check.outputs.is_active == 'true'
    runs-on: ubuntu-latest
    container:
      image: openwrt/sdk:${{ needs.check.outputs.target_arch }}-${{ needs.check.outputs.target_branch }}
      options: --user root
    outputs:
      pkgver: ${{ steps.init.outputs.pkgver }}
    steps:
      - name: Checkout packaging repo
        uses: actions/checkout@v4
        with:
          path: zapret-openwrt

      - name: Setup OpenWrt SDK
        working-directory: /builder
        shell: bash
        run: |
          gpg --batch --import <(wget -qO- 'https://raw.githubusercontent.com/openwrt/keyring/refs/heads/master/gpg/0x1D53D1877742E911.asc') || true
          sed -i 's/gpg --/#gpg --/g' setup.sh
          sed -r -i 's/^rm.+//' setup.sh
          ./setup.sh
          echo "PKGTYPE=ipk" >> $GITHUB_ENV

      - name: Update Makefiles
        working-directory: /builder
        env:
          ZAPRET_COMMIT: ${{ needs.check.outputs.zapret_commit }}
        run: |
          PKGDIR=$GITHUB_WORKSPACE/zapret-openwrt
          TODAY=$(date +%Y%m%d)
          ZAPRET_MF="$PKGDIR/zapret2/Makefile"
          TMPFILE=$(mktemp)
          curl -sL "https://github.com/bol-van/zapret2/archive/$ZAPRET_COMMIT.tar.gz" -o "$TMPFILE"
          LATEST_HASH=$(sha256sum "$TMPFILE" | awk '{print $1}')
          sed -i "s|^PKG_SOURCE_VERSION:=.*|PKG_SOURCE_VERSION:=$ZAPRET_COMMIT|" "$ZAPRET_MF"
          sed -i "s|^PKG_MIRROR_HASH:=.*|PKG_MIRROR_HASH:=$LATEST_HASH|" "$ZAPRET_MF"
          sed -i "s|^PKG_VERSION:=.*|PKG_VERSION:=0.8.$TODAY|" "$ZAPRET_MF"
          LUCI_MF="$PKGDIR/luci-app-zapret2/Makefile"
          [ -f "$LUCI_MF" ] && sed -i "s|^PKG_VERSION:=.*|PKG_VERSION:=0.8.$TODAY|" "$LUCI_MF"

      - name: Init packages
        id: init
        working-directory: /builder
        env:
          FAKE_BUILD: ${{ needs.check.outputs.fake_build }}
        shell: bash
        run: |
          PKGDIR=$GITHUB_WORKSPACE/zapret-openwrt
          MKFN=$PKGDIR/luci-app-zapret2/Makefile
          PKGVER=$(grep '^PKG_VERSION:=' $MKFN | cut -d'=' -f2)
          mkdir -p ./package/zapret-openwrt
          cp -vr $PKGDIR/* ./package/zapret-openwrt/
          mv feeds.conf.default feeds.conf
          if [ "$FAKE_BUILD" = "false" ]; then
              ./scripts/feeds update base packages luci
              ./scripts/feeds install -a
          fi
          echo "pkgver=$PKGVER" >> $GITHUB_OUTPUT

      - name: Build packages
        working-directory: /builder
        env:
          FAKE_BUILD: ${{ needs.check.outputs.fake_build }}
          MAX_SPEED: ${{ needs.check.outputs.max_speed }}
          PKGVER: ${{ steps.init.outputs.pkgver }}
          TARGET_ARCH: ${{ needs.check.outputs.target_arch }}
        shell: bash
        run: |
          if [ "$FAKE_BUILD" = "false" ]; then
              make defconfig
              PKGLIST="package/zapret-openwrt/zapret2/compile package/zapret-openwrt/luci-app-zapret2/compile"
              [ "$MAX_SPEED" = "true" ] && make -j$(nproc) $PKGLIST || make $PKGLIST V=s
          else
              OUT_DIR=./bin/packages/dev/base
              mkdir -p $OUT_DIR
              touch $OUT_DIR/zapret2_${PKGVER}_${TARGET_ARCH}.ipk
              touch $OUT_DIR/luci-app-zapret2_${PKGVER}_all.ipk
          fi
          EXPORT_DIR=$GITHUB_WORKSPACE/ipk-export
          mkdir -p $EXPORT_DIR
          find ./bin/packages/ -name "*.ipk" -exec cp {} $EXPORT_DIR/ \;
          echo "OUTDIR=$EXPORT_DIR" >> $GITHUB_ENV

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          path: ipk-export
          name: zapret-packages-${{ needs.check.outputs.target_arch }}

  release:
    needs: [ check, build ]
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: zapret-packages-${{ needs.check.outputs.target_arch }}
          path: ./release_files

      - name: Create Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          draft: ${{ needs.check.outputs.test_build == 'true' || needs.check.outputs.fake_build == 'true' }}
          tag_name: v${{ needs.build.outputs.pkgver }}${{ (needs.check.outputs.fake_build == 'true' && '-fake') || (needs.check.outputs.test_build == 'true' && '-test') || '' }}
          name: zapret2 v${{ needs.build.outputs.pkgver }}
          files: ./release_files/*.ipk
          body: |
            ## Build Information
            - **Arch**: ${{ needs.check.outputs.target_arch }}
            - **SDK**: ${{ needs.check.outputs.target_branch }}
            - **Upstream Commit**: ${{ needs.check.outputs.zapret_commit_short }}
